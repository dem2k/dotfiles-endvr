#!/usr/bin/bash

# ==========[ DDD - DD mit fzf ]===========

# â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
# â”‚ Einfacher Wrapper fÃ¼r dd mit Fortschritts-   â”‚
# â”‚ anzeige via pv und Auswahl via fzf          â”‚
# â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

# PrÃ¼fen, ob das Skript in einem Terminal lÃ¤uft
if [[ ! -t 0 || ! -t 1 ]]; then
  echo "âŒ Fehler: Dieses Skript muss in einem Terminal ausgefÃ¼hrt werden."
  echo "   Bitte Ã¶ffne ein Terminal und fÃ¼hre das Skript dort aus."
  exit 1
fi

# PrÃ¼fen, ob fzf installiert ist
if ! command -v fzf &> /dev/null; then
  echo "âŒ Fehler: fzf ist nicht installiert."
  exit 1
fi

# Parameter parsen
while [[ $# -gt 0 ]]; do
  case "$1" in
    -if)
      SOURCE="$2"
      shift 2
      ;;
    -of)
      DEST="$2"
      shift 2
      ;;
    *)
      echo "Unbekannter Parameter: $1"
      echo "Benutzung: ddd -if <inputfile> [-of <outputdevice>]"
      exit 1
      ;;
  esac
done

# Validierung: Input-Datei
if [[ -z "$SOURCE" ]]; then
  echo "âŒ Fehler: -if (Input-Datei) muss angegeben werden."
  exit 1
fi
 
if [[ ! -f "$SOURCE" ]]; then
  echo "âŒ Fehler: Input-Datei '$SOURCE' existiert nicht."
  exit 1
fi

# Wenn -of fehlt â†’ interaktive Auswahl anzeigen
if [[ -z "$DEST" ]]; then
  echo "ğŸ” Suche verfÃ¼gbare GerÃ¤te..."
  
  DISK_LIST="DEVICE;GRÃ–SSE;VENDOR;MODEL;LABEL"$'\n'
  for devpath in /dev/sd?; do
    if [[ -b "$devpath" ]]; then
      devname=$(basename "$devpath")
      # GrÃ¶ÃŸe in Bytes â†’ formatiert
      SIZE=$(lsblk -b -dn -o SIZE "$devpath" 2>/dev/null)
      SIZE_H=$(numfmt --to=iec-i --suffix=B "$SIZE" 2>/dev/null || echo "Unbekannt")
      # Vendor, Model und Label mit udevadm
      VENDOR=$(udevadm info --query=all --name="$devpath" 2>/dev/null | grep "ID_VENDOR=" | cut -d= -f2)
      MODEL=$(udevadm info --query=all --name="$devpath" 2>/dev/null | grep "ID_MODEL=" | cut -d= -f2)
      # Label von der ersten Partition holen
      LABEL=$(lsblk -n -o LABEL "${devpath}1" 2>/dev/null | head -1 | tr -d '[:space:]')
      
      [[ -z "$VENDOR" ]] && VENDOR="Unbekannt"
      [[ -z "$MODEL" ]] && MODEL="Unbekannt"
      [[ -z "$LABEL" ]] && LABEL="(Kein Label)"
      
      # Zeile fÃ¼r fzf formatieren
      DISK_LIST+="${devpath};${SIZE_H};${VENDOR};${MODEL};${LABEL}"$'\n'
    fi
  done

  if [[ -z "$DISK_LIST" ]]; then
    echo "âŒ Keine geeigneten ZielgerÃ¤te gefunden (z.B. /dev/sdX)."
    exit 1
  fi

  # fzf-Auswahl mit Header
  SELECTION=$(echo -n "$DISK_LIST" | column -ts';' | fzf \
    --header="WÃ¤hle das ZielgerÃ¤t (SD-Karte, USB-Stick)" \
    --header-first --header-lines=1 \
    --height=40% --border --reverse --ansi)
 
  # PrÃ¼fen, ob abgebrochen
  if [[ -z "$SELECTION" ]]; then
    echo "Abgebrochen."
    exit 1
  fi
  
  # Device-Pfad extrahieren (erstes Feld vor |)
  DEST=$(echo "$SELECTION" | awk '{print $1}' | tr -d '[:space:]')
fi

# Validierung des ZielgerÃ¤ts
if [[ ! -b "$DEST" ]]; then
  echo "âŒ Fehler: ZielgerÃ¤t '$DEST' ist kein gÃ¼ltiges Block-Device."
  exit 1
fi
 
# BestÃ¤tigung anzeigen
echo ""
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo "  Quelle: $SOURCE"
echo "  Ziel  : $DEST"
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo ""
read -p "âš ï¸ WARNUNG: Alle Daten auf $DEST werden Ã¼berschrieben! Fortfahren? [j/N] " -n 1 -r
echo ""

if [[ ! $REPLY =~ ^[Jj]$ ]]; then
  echo "Abgebrochen."
  exit 1
fi

echo ""
echo "ğŸš€ Starte Kopiervorgang..."
echo ""
 
pv "$SOURCE" | dd of="$DEST" bs=1M oflag=sync

echo ""
echo "âœ… Kopiervorgang abgeschlossen!"
echo ""
